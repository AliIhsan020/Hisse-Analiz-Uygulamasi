import yfinance as yf
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')

# =============================================================================
# G√úNCELLENMI≈û Fƒ∞LTRE KRƒ∞TERLERƒ∞ - ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û VERSƒ∞YON
# =============================================================================

# üü¢ OLUMLU NOKTALAR (Aynen kalsƒ±n)
# RSI Kriterleri - M√ºkemmel seviye, ne √ßok dipte ne a≈üƒ±rƒ± alƒ±mda
MIN_RSI = 40          # Minimum RSI deƒüeri
MAX_RSI = 60          # Maksimum RSI deƒüeri (>60 ise alma)

# MACD Kriterleri - Momentumun yeni ba≈üladƒ±ƒüƒ± noktalarƒ± yakalar
MACD_CROSSOVER = True    # MACD √ßizgisi sinyal √ßizgisini a≈üaƒüƒ±dan yukarƒ± kesmi≈ü olmalƒ±
MACD_HISTOGRAM_POSITIVE = True  # MACD histogram pozitif olmalƒ±

# üü° ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û NOKTALAR
# Hacim Kriterleri - Likidite i√ßin artƒ±rƒ±ldƒ±
MIN_VOLUME = 500000     # Minimum g√ºnl√ºk hacim (150k'dan 500k'ya √ßƒ±karƒ±ldƒ± - spread korumasƒ±)
VOLUME_INCREASE_MIN = 1.2  # Son g√ºn hacim, son 5 g√ºnl√ºk ortalamanƒ±n %20 √ºst√º olmalƒ±
VOLUME_LOOKBACK_DAYS = 5   # Hacim kar≈üƒ±la≈ütƒ±rmasƒ± i√ßin g√ºn sayƒ±sƒ±

# EMA Kriterleri - Kƒ±sa vadeli pozitif trend garantisi
EMA20_ABOVE_EMA50 = True    # EMA20 > EMA50
PRICE_NEAR_EMA20 = True     # Fiyat EMA20'ye yakƒ±n ama √ßok √ºst√ºnde olmamalƒ±
MAX_PRICE_EMA20_DISTANCE = 0.03  # Fiyat EMA20'den maksimum %3 uzakta (5%'den d√º≈ü√ºr√ºld√º)

# ATR Kriterleri - Ne √∂l√º hisse, ne spek√ºlatif √ßƒ±lgƒ±nlƒ±k
MIN_ATR_PERCENT = 3.0   # Minimum %3 g√ºnl√ºk hareket
MAX_ATR_PERCENT = 6.0   # Maksimum %6 g√ºnl√ºk hareket

# üî¥ KRƒ∞Tƒ∞K DENGE NOKTALARI - ƒ∞yile≈ütirildi
# Destek/Diren√ß Kriterleri
NEAR_SUPPORT = True     # Fiyat destek b√∂lgesine yakƒ±n olmalƒ±
MAX_SUPPORT_DISTANCE = 0.03  # Destekten maksimum %3 uzakta
MAX_STOP_LOSS_DISTANCE = 0.04  # Stop-loss mesafesi %4'√º ge√ßmemeli (ger√ßek√ßi seviye)
RESISTANCE_POTENTIAL = True   # 2-3 g√ºn i√ßinde diren√ß seviyesine ula≈üma potansiyeli
MAX_RESISTANCE_DISTANCE = 0.06  # Diren√ßten maksimum %6 uzakta (8%'den d√º≈ü√ºr√ºld√º - daha ger√ßek√ßi)

# Destek/Diren√ß analiz parametreleri - 3'e √ßƒ±karƒ±ldƒ±
SUPPORT_RESISTANCE_COUNT = 3  # G√∂sterilecek destek/diren√ß sayƒ±sƒ± (2'den 3'e √ßƒ±karƒ±ldƒ±)

# Fiyat Kriterleri - Uygun, spek hisseleri hari√ß tutar
MIN_PRICE = 3.0
MAX_PRICE = 500.0

# BIST 100 hisse kodlarƒ± (g√ºncellenmi≈ü liste)
BIST100_STOCKS = [
    'THYAO', 'AKBNK', 'ISCTR', 'GARAN', 'VAKBN', 'SASA', 'KCHOL', 'ARCLK', 
    'TUPRS', 'EREGL', 'HALKB', 'TCELL', 'BIMAS', 'SAHOL', 'ASELS', 'KOZAL',
    'PGSUS', 'MGROS', 'SOKM', 'ENKAI', 'OYAKC', 'TOASO', 'PETKM', 'TKFEN',
    'SISE', 'OTKAR', 'AEFES', 'CCOLA', 'ULKER', 'VESTL', 'FROTO', 'GUBRF',
    'ALARK', 'TTKOM', 'KOZAA', 'TAVHL', 'DOHOL', 'ECILC', 'YKBNK', 'ZOREN',
    'LOGO', 'TSKB', 'AKSA', 'AKSEN', 'BRISA', 'CEMTS', 'CIMSA', 'EGEEN',
    'ENJSA', 'FENER', 'GLYHO', 'HEKTS', 'IHLAS', 'IHYAY', 'IZMDC', 'KARSN',
    'KAYSE', 'KLMSN', 'KONYA', 'KRONT', 'MAVI', 'MPARK', 'NETAS', 'PARSN',
    'PINSU', 'PRKME', 'RAYSG', 'RTALB', 'SARKY', 'SELEC', 'SMART', 'SMRTG',
    'TATEN', 'TBORG', 'TEZOL', 'TIRE', 'TRCAS', 'TURSG', 'UFUK', 'ULUSE',
    'UNYEC', 'VAKKO', 'VESBE', 'YAPRK', 'YESIL', 'YGYO', 'ZEDUR', 'ADEL',
    'AGHOL', 'AGROT', 'AHGAZ', 'AKGRT', 'ALCTL', 'ALGYO', 'ALKIM', 'ALTIN',
    'ANSGR', 'ARDYZ', 'ASTOR', 'AVGYO', 'AVHOL', 'AVTUR', 'AYCES', 'AYEN',
    'AYGAZ', 'BAKAB', 'BANVT', 'BASGZ', 'BAYRK', 'BEGYO', 'BERA', 'BEYAZ',
    'BFREN', 'BIGYO', 'BIOEN', 'BJKAS', 'BLCYT', 'BMSCH', 'BMSTL', 'BNTAS',
    'BOBET', 'BOLUC', 'BOSSA', 'BRKO', 'BRKSN', 'BRKVY', 'BSOKE', 'BTCIM'
]

def calculate_rsi(prices, period=14):
    """RSI hesaplama fonksiyonu"""
    delta = prices.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

def calculate_ema(prices, period):
    """EMA hesaplama fonksiyonu"""
    return prices.ewm(span=period).mean()

def calculate_macd(prices, fast=12, slow=26, signal=9):
    """MACD hesaplama fonksiyonu"""
    ema_fast = prices.ewm(span=fast).mean()
    ema_slow = prices.ewm(span=slow).mean()
    macd_line = ema_fast - ema_slow
    signal_line = macd_line.ewm(span=signal).mean()
    histogram = macd_line - signal_line
    return macd_line, signal_line, histogram

def calculate_atr(high, low, close, period=14):
    """ATR (Average True Range) hesaplama"""
    high_low = high - low
    high_close = np.abs(high - close.shift())
    low_close = np.abs(low - close.shift())
    
    ranges = pd.concat([high_low, high_close, low_close], axis=1)
    true_range = ranges.max(axis=1)
    atr = true_range.rolling(window=period).mean()
    
    return atr

def calculate_support_strength(prices, support_level, window=20):
    """Destek seviyesinin g√ºc√ºn√º hesapla"""
    touches = 0
    bounces = 0
    tolerance = support_level * 0.02  # %2 tolerans
    
    for i in range(len(prices) - window, len(prices)):
        if i > 0:
            # Destek seviyesine yakla≈üma
            if abs(prices.iloc[i] - support_level) <= tolerance:
                touches += 1
                # Destek seviyesinden yukarƒ± sƒ±√ßrama
                if i < len(prices) - 1 and prices.iloc[i+1] > prices.iloc[i]:
                    bounces += 1
    
    if touches == 0:
        return 0
    
    strength = (bounces / touches) * min(touches, 5)  # Max 5 puan
    return min(strength, 5)  # 0-5 arasƒ± g√º√ß skoru

def find_support_resistance_levels(prices, window=20):
    """Geli≈ütirilmi≈ü destek ve diren√ß seviyelerini bul - 3 seviye + g√º√ß analizi"""
    supports = []
    resistances = []
    
    for i in range(window, len(prices) - window):
        # Yerel minimum (destek)
        if prices.iloc[i] == prices.iloc[i-window:i+window].min():
            strength = calculate_support_strength(prices, prices.iloc[i], window)
            supports.append((prices.iloc[i], strength))
        
        # Yerel maksimum (diren√ß)
        if prices.iloc[i] == prices.iloc[i-window:i+window].max():
            strength = calculate_support_strength(prices, prices.iloc[i], window)
            resistances.append((prices.iloc[i], strength))
    
    # G√º√ßl√º seviyeler √∂ncelikli olmak √ºzere sƒ±rala
    supports = sorted(supports, key=lambda x: (-x[1], -x[0]))  # G√ºce g√∂re, sonra fiyata g√∂re
    resistances = sorted(resistances, key=lambda x: (-x[1], x[0]))  # G√ºce g√∂re, sonra fiyata g√∂re
    
    # En g√º√ßl√º 3 seviyeyi al
    top_supports = supports[:SUPPORT_RESISTANCE_COUNT]
    top_resistances = resistances[:SUPPORT_RESISTANCE_COUNT]
    
    return top_supports, top_resistances

def check_volume_increase(volume, days=VOLUME_LOOKBACK_DAYS):
    """Geli≈ütirilmi≈ü hacim artƒ±≈ü kontrol√º - son N g√ºnl√ºk ortalama ile kar≈üƒ±la≈ütƒ±r"""
    if len(volume) < days + 1:
        return 1.0
    
    current_volume = volume.iloc[-1]
    avg_volume = volume.iloc[-(days+1):-1].mean()  # Son N g√ºn√ºn ortalamasƒ± (bug√ºn hari√ß)
    
    if avg_volume == 0:
        return 1.0
    
    return current_volume / avg_volume

def check_macd_crossover(macd_line, signal_line, lookback=5):
    """MACD √ßizgisinin sinyal √ßizgisini a≈üaƒüƒ±dan yukarƒ± kesip kesmediƒüini kontrol et"""
    if len(macd_line) < lookback + 1:
        return False
    
    # Son lookback g√ºn i√ßinde crossover var mƒ±?
    for i in range(len(macd_line) - lookback, len(macd_line)):
        if i > 0:
            # √ñnceki g√ºn MACD < Signal, bug√ºn MACD > Signal
            if (macd_line.iloc[i-1] < signal_line.iloc[i-1] and 
                macd_line.iloc[i] > signal_line.iloc[i]):
                return True
    return False

def analyze_stock_comprehensive(ticker):
    """Kapsamlƒ± hisse analizi"""
    try:
        bist_ticker = ticker.strip().upper()
        if not bist_ticker.endswith('.IS'):
            bist_ticker += '.IS'
        
        stock = yf.Ticker(bist_ticker)
        hist = stock.history(period="6mo")
        
        if len(hist) < 50:
            return None
        
        close = hist['Close']
        high = hist['High']
        low = hist['Low']
        volume = hist['Volume']
        
        # Temel veriler
        current_price = close.iloc[-1]
        current_volume = volume.iloc[-1]
        
        # Geli≈ütirilmi≈ü hacim artƒ±≈ü kontrol√º
        volume_increase = check_volume_increase(volume)
        
        # EMA hesaplamalarƒ±
        ema_20 = calculate_ema(close, 20).iloc[-1]
        ema_50 = calculate_ema(close, 50).iloc[-1] if len(close) >= 50 else None
        
        # RSI
        rsi = calculate_rsi(close).iloc[-1]
        
        # MACD
        macd_line, signal_line, histogram = calculate_macd(close)
        current_macd = macd_line.iloc[-1]
        current_signal = signal_line.iloc[-1]
        current_histogram = histogram.iloc[-1]
        macd_crossover = check_macd_crossover(macd_line, signal_line)
        
        # ATR
        atr = calculate_atr(high, low, close).iloc[-1]
        atr_percent = (atr / current_price) * 100
        
        # Geli≈ütirilmi≈ü destek ve diren√ß seviyeleri (g√º√ß analizi ile)
        supports_with_strength, resistances_with_strength = find_support_resistance_levels(close)
        
        # Destek ve diren√ß uzaklƒ±klarƒ±
        support_distances = []
        resistance_distances = []
        
        for support_price, strength in supports_with_strength:
            distance = ((current_price - support_price) / support_price) * 100
            support_distances.append(distance)
        
        for resistance_price, strength in resistances_with_strength:
            distance = ((resistance_price - current_price) / current_price) * 100
            resistance_distances.append(distance)
        
        # En yakƒ±n destek ve diren√ß
        nearest_support = supports_with_strength[0][0] if supports_with_strength else None
        nearest_resistance = resistances_with_strength[0][0] if resistances_with_strength else None
        
        return {
            'ticker': ticker.upper(),
            'price': current_price,
            'volume': current_volume,
            'volume_increase': volume_increase,
            'rsi': rsi,
            'ema_20': ema_20,
            'ema_50': ema_50,
            'macd': current_macd,
            'signal': current_signal,
            'histogram': current_histogram,
            'macd_crossover': macd_crossover,
            'atr_percent': atr_percent,
            'supports_with_strength': supports_with_strength,
            'resistances_with_strength': resistances_with_strength,
            'support_distances': support_distances,
            'resistance_distances': resistance_distances,
            'nearest_support': nearest_support,
            'nearest_resistance': nearest_resistance
        }
        
    except Exception as e:
        print(f"Hata {ticker}: {e}")
        return None

def check_new_filters(stock):
    """Yeni filtrelere g√∂re hisse kontrol√º"""
    if not stock:
        return False
    
    # Fiyat filtreleri
    if not (MIN_PRICE <= stock['price'] <= MAX_PRICE):
        return False
    
    # Minimum hacim kontrol√º
    if stock['volume'] < MIN_VOLUME:
        return False
    
    # RSI filtreleri (40-60 arasƒ±, >60 ise alma)
    if not (MIN_RSI <= stock['rsi'] <= MAX_RSI):
        return False
    
    # MACD crossover kontrol√º
    if MACD_CROSSOVER and not stock['macd_crossover']:
        return False
    
    # MACD histogram pozitif kontrol√º
    if MACD_HISTOGRAM_POSITIVE and stock['histogram'] <= 0:
        return False
    
    # Geli≈ütirilmi≈ü hacim artƒ±≈ü kontrol√º
    if stock['volume_increase'] < VOLUME_INCREASE_MIN:
        return False
    
    # EMA20 > EMA50 kontrol√º
    if EMA20_ABOVE_EMA50 and stock['ema_50']:
        if stock['ema_20'] <= stock['ema_50']:
            return False
    
    # Fiyat EMA20'ye yakƒ±n kontrol√º (daha sƒ±kƒ± %3)
    if PRICE_NEAR_EMA20:
        price_ema20_distance = abs(stock['price'] - stock['ema_20']) / stock['ema_20']
        if price_ema20_distance > MAX_PRICE_EMA20_DISTANCE:
            return False
    
    # ATR kontrol√º
    if not (MIN_ATR_PERCENT <= stock['atr_percent'] <= MAX_ATR_PERCENT):
        return False
    
    # Destek yakƒ±nlƒ±ƒüƒ± kontrol√º
    if NEAR_SUPPORT and stock['nearest_support']:
        support_distance = abs(stock['price'] - stock['nearest_support']) / stock['nearest_support']
        if support_distance > MAX_SUPPORT_DISTANCE:
            return False
    
    # Stop-loss mesafesi kontrol√º (ger√ßek√ßi %4)
    if stock['nearest_support']:
        stop_loss_distance = (stock['price'] - stock['nearest_support']) / stock['price']
        if stop_loss_distance > MAX_STOP_LOSS_DISTANCE:
            return False
    
    # Diren√ß potansiyeli kontrol√º (daha ger√ßek√ßi %6)
    if RESISTANCE_POTENTIAL and stock['nearest_resistance']:
        resistance_distance = (stock['nearest_resistance'] - stock['price']) / stock['price']
        if resistance_distance > MAX_RESISTANCE_DISTANCE:
            return False
    
    return True

def calculate_proximity_score(stock):
    """Hissenin kriterlere ne kadar yakƒ±n olduƒüunu hesapla"""
    score = 0
    max_score = 0
    
    # RSI skoru
    max_score += 1
    if MIN_RSI <= stock['rsi'] <= MAX_RSI:
        score += 1
    else:
        if stock['rsi'] < MIN_RSI:
            distance = MIN_RSI - stock['rsi']
            score += max(0, 1 - distance/20)
        else:
            distance = stock['rsi'] - MAX_RSI
            score += max(0, 1 - distance/20)
    
    # MACD crossover skoru
    max_score += 1
    if stock['macd_crossover']:
        score += 1
    else:
        score += 0.3
    
    # MACD histogram skoru
    max_score += 1
    if stock['histogram'] > 0:
        score += 1
    else:
        score += 0.3
    
    # Hacim artƒ±≈ü skoru
    max_score += 1
    if stock['volume_increase'] >= VOLUME_INCREASE_MIN:
        score += 1
    else:
        score += max(0, stock['volume_increase'] / VOLUME_INCREASE_MIN)
    
    # EMA skoru
    if stock['ema_50']:
        max_score += 1
        if stock['ema_20'] > stock['ema_50']:
            score += 1
        else:
            score += 0.3
    
    # Fiyat EMA20 yakƒ±nlƒ±k skoru
    max_score += 1
    price_ema20_distance = abs(stock['price'] - stock['ema_20']) / stock['ema_20']
    if price_ema20_distance <= MAX_PRICE_EMA20_DISTANCE:
        score += 1
    else:
        score += max(0, 1 - price_ema20_distance/0.1)
    
    # ATR skoru
    max_score += 1
    if MIN_ATR_PERCENT <= stock['atr_percent'] <= MAX_ATR_PERCENT:
        score += 1
    else:
        score += 0.3
    
    return score / max_score if max_score > 0 else 0

def format_support_strength(strength):
    """Destek g√ºc√ºn√º formatla"""
    if strength >= 4:
        return "üî¥ √áok G√º√ßl√º"
    elif strength >= 3:
        return "üü† G√º√ßl√º"
    elif strength >= 2:
        return "üü° Orta"
    elif strength >= 1:
        return "üü¢ Zayƒ±f"
    else:
        return "‚ö™ √áok Zayƒ±f"

def format_stock_summary(stock):
    """Hisse √∂zet bilgilerini formatla - 3 seviye + g√º√ß g√∂stergesi"""
    # En g√º√ßl√º 3 destek (fiyat, uzaklƒ±k ve g√º√ß)
    support_text = "Yok"
    if len(stock['supports_with_strength']) >= 3:
        support_parts = []
        for i in range(3):
            price, strength = stock['supports_with_strength'][i]
            distance = stock['support_distances'][i]
            strength_text = format_support_strength(strength)
            support_parts.append(f"{price:.2f}TL (%{distance:.1f}) {strength_text}")
        support_text = " | ".join(support_parts)
    elif len(stock['supports_with_strength']) > 0:
        support_parts = []
        for i, (price, strength) in enumerate(stock['supports_with_strength']):
            distance = stock['support_distances'][i]
            strength_text = format_support_strength(strength)
            support_parts.append(f"{price:.2f}TL (%{distance:.1f}) {strength_text}")
        support_text = " | ".join(support_parts)
    
    # En g√º√ßl√º 3 diren√ß (fiyat, uzaklƒ±k ve g√º√ß)
    resistance_text = "Yok"
    if len(stock['resistances_with_strength']) >= 3:
        resistance_parts = []
        for i in range(3):
            price, strength = stock['resistances_with_strength'][i]
            distance = stock['resistance_distances'][i]
            strength_text = format_support_strength(strength)
            resistance_parts.append(f"{price:.2f}TL (%{distance:.1f}) {strength_text}")
        resistance_text = " | ".join(resistance_parts)
    elif len(stock['resistances_with_strength']) > 0:
        resistance_parts = []
        for i, (price, strength) in enumerate(stock['resistances_with_strength']):
            distance = stock['resistance_distances'][i]
            strength_text = format_support_strength(strength)
            resistance_parts.append(f"{price:.2f}TL (%{distance:.1f}) {strength_text}")
        resistance_text = " | ".join(resistance_parts)
    
    return {
        "Hisse": stock['ticker'],
        "G√ºncel Fiyat": f"{stock['price']:.2f}TL",
        "En G√º√ßl√º 3 Destek": support_text,
        "En G√º√ßl√º 3 Diren√ß": resistance_text,
        "Hacim Artƒ±≈üƒ±": f"%{(stock['volume_increase']-1)*100:.1f}",
        "G√ºnl√ºk Hacim": f"{stock['volume']:,.0f}",
        "ATR": f"%{stock['atr_percent']:.1f}"
    }

def explain_why_not_matching(stock):
    """Hissenin neden filtrelere uymadƒ±ƒüƒ±nƒ± a√ßƒ±klar"""
    reasons = []
    
    if not (MIN_PRICE <= stock['price'] <= MAX_PRICE):
        reasons.append(f"Fiyat {stock['price']:.2f} TL, aralƒ±k dƒ±≈üƒ±nda ({MIN_PRICE}-{MAX_PRICE} TL)")
    
    if stock['volume'] < MIN_VOLUME:
        reasons.append(f"G√ºnl√ºk hacim yetersiz ({stock['volume']:,.0f} < {MIN_VOLUME:,})")
    
    if not (MIN_RSI <= stock['rsi'] <= MAX_RSI):
        reasons.append(f"RSI {stock['rsi']:.1f}, aralƒ±k dƒ±≈üƒ±nda ({MIN_RSI}-{MAX_RSI})")
    
    if not stock['macd_crossover']:
        reasons.append("MACD √ßizgisi sinyal √ßizgisini a≈üaƒüƒ±dan yukarƒ± kesmemi≈ü")
    
    if stock['histogram'] <= 0:
        reasons.append("MACD histogram pozitif deƒüil")
    
    if stock['volume_increase'] < VOLUME_INCREASE_MIN:
        reasons.append(f"Hacim artƒ±≈üƒ± yetersiz (%{(stock['volume_increase']-1)*100:.1f} < %{(VOLUME_INCREASE_MIN-1)*100:.0f})")
    
    if stock['ema_50'] and stock['ema_20'] <= stock['ema_50']:
        reasons.append("EMA20 EMA50'nin √ºst√ºnde deƒüil")
    
    price_ema20_distance = abs(stock['price'] - stock['ema_20']) / stock['ema_20']
    if price_ema20_distance > MAX_PRICE_EMA20_DISTANCE:
        reasons.append(f"Fiyat EMA20'den √ßok uzak (%{price_ema20_distance*100:.1f} > %{MAX_PRICE_EMA20_DISTANCE*100:.0f})")
    
    if not (MIN_ATR_PERCENT <= stock['atr_percent'] <= MAX_ATR_PERCENT):
        reasons.append(f"ATR aralƒ±k dƒ±≈üƒ±nda (%{stock['atr_percent']:.1f})")
    
    if stock['nearest_support']:
        support_distance = abs(stock['price'] - stock['nearest_support']) / stock['nearest_support']
        if support_distance > MAX_SUPPORT_DISTANCE:
            reasons.append(f"En yakƒ±n destekten √ßok uzak (%{support_distance*100:.1f} > %{MAX_SUPPORT_DISTANCE*100:.0f})")
    
    return reasons

def scan_and_filter_stocks(selected_stocks=None):
    """Hisseleri tara ve filtrele"""
    stocks_to_scan = selected_stocks if selected_stocks else BIST100_STOCKS
    scan_type = "Se√ßilen" if selected_stocks else "BIST100"
    
    print(f"üîç {scan_type} hisseler taranƒ±yor...")
    print("Bu i≈ülem birka√ß dakika s√ºrebilir...\n")
    
    all_results = []
    filtered_results = []
    processed = 0
    
    for ticker in stocks_to_scan:
        processed += 1
        print(f"ƒ∞≈üleniyor: {ticker} ({processed}/{len(stocks_to_scan)})", end='\r')
        
        result = analyze_stock_comprehensive(ticker)
        if result:
            all_results.append(result)
            if check_new_filters(result):
                filtered_results.append(result)
    
    print(f"\n‚úÖ Toplam {len(all_results)} hisse analiz edildi.")
    print(f"üéØ {len(filtered_results)} hisse kriterlere uygun bulundu.\n")
    
    return filtered_results, all_results

def display_results(filtered_results, all_results, is_specific_search=False):
    """Sonu√ßlarƒ± g√∂ster"""
    
    if is_specific_search:
        # Belirli hisse aramasƒ± - hem uygun hem uymayanlarƒ± g√∂ster
        if filtered_results:
            print(f"{'='*100}")
            print(f"KRƒ∞TERLERE UYGUN Hƒ∞SSELER ({len(filtered_results)} adet)")
            print(f"{'='*100}")
            
            table_data = []
            for stock in filtered_results:
                table_data.append(format_stock_summary(stock))
            
            df = pd.DataFrame(table_data)
            print(df.to_string(index=False))
        
        # Kriterlere uymayanlar
        non_matching = [s for s in all_results if s not in filtered_results]
        if non_matching:
            print(f"\n{'='*100}")
            print(f"KRƒ∞TERLERE UYGUN OLMAYAN Hƒ∞SSELER ({len(non_matching)} adet)")
            print(f"{'='*100}")
            
            for stock in non_matching:
                print(f"\nüìä {stock['ticker']} - G√ºncel Fiyat: {stock['price']:.2f}TL - Hacim: {stock['volume']:,.0f}")
                
                # G√º√ßl√º destek ve diren√ß bilgileri detaylƒ± g√∂ster
                if stock['supports_with_strength']:
                    print("   G√º√ßl√º Destekler:")
                    for i, (support, strength) in enumerate(stock['supports_with_strength'][:3]):
                        distance = stock['support_distances'][i]
                        strength_text = format_support_strength(strength)
                        print(f"     {i+1}. {support:.2f}TL (Uzaklƒ±k: %{distance:.1f}) - {strength_text}")
                
                if stock['resistances_with_strength']:
                    print("   G√º√ßl√º Diren√ßler:")
                    for i, (resistance, strength) in enumerate(stock['resistances_with_strength'][:3]):
                        distance = stock['resistance_distances'][i]
                        strength_text = format_support_strength(strength)
                        print(f"     {i+1}. {resistance:.2f}TL (Uzaklƒ±k: %{distance:.1f}) - {strength_text}")
                
                print(f"   Hacim Artƒ±≈üƒ±: %{(stock['volume_increase']-1)*100:.1f}")
                print(f"   ATR: %{stock['atr_percent']:.1f}")
                
                reasons = explain_why_not_matching(stock)
                print("   Uyumsuzluk Sebepleri:")
                for reason in reasons:
                    print(f"     ‚Ä¢ {reason}")
    
    else:
        # BIST100 aramasƒ± - sadece uygun olanlarƒ± g√∂ster
        if filtered_results:
            print(f"{'='*100}")
            print(f"KRƒ∞TERLERE UYGUN Hƒ∞SSELER ({len(filtered_results)} adet)")
            print(f"{'='*100}")
            
            table_data = []
            for stock in filtered_results:
                table_data.append(format_stock_summary(stock))
            
            df = pd.DataFrame(table_data)
            print(df.to_string(index=False))
        
        else:
            # Hi√ß uygun hisse yok - en yakƒ±n 5'i g√∂ster
            print("‚ùå Kriterlere uygun hisse bulunamadƒ±!")
            print("\nüîç Kriterlere en yakƒ±n 5 hisse:\n")
            
            scored_stocks = []
            for stock in all_results:
                score = calculate_proximity_score(stock)
                scored_stocks.append((score, stock))
            
            scored_stocks.sort(reverse=True, key=lambda x: x[0])
            
            for i, (score, stock) in enumerate(scored_stocks[:5], 1):
                print(f"{i}. üìä {stock['ticker']} (Yakƒ±nlƒ±k Skoru: {score:.2f})")
                summary = format_stock_summary(stock)
                for key, value in summary.items():
                    if key != "Hisse":
                        print(f"   {key}: {value}")
                
                reasons = explain_why_not_matching(stock)
                print("   Kriterlere Uymama Sebepleri:")
                for reason in reasons:
                    print(f"     ‚Ä¢ {reason}")
                print()

def show_current_filters():
    """Mevcut filtreleri g√∂ster"""
    print(f"\n{'='*80}")
    print(f"G√úNCEL Fƒ∞LTRE KRƒ∞TERLERƒ∞ - ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û VERSƒ∞YON")
    print(f"{'='*80}")
    print(f"üü¢ OLUMLU NOKTALAR (Aynen korundu):")
    print(f"   ‚Ä¢ RSI: {MIN_RSI}-{MAX_RSI} (>{MAX_RSI} ise alma)")
    print(f"   ‚Ä¢ MACD: √áizgi sinyal √ßizgisini a≈üaƒüƒ±dan yukarƒ± kesmi≈ü olmalƒ±")
    print(f"   ‚Ä¢ MACD Histogram: Pozitif olmalƒ±")
    print(f"   ‚Ä¢ EMA: EMA20 > EMA50")
    print(f"   ‚Ä¢ ATR: %{MIN_ATR_PERCENT}-{MAX_ATR_PERCENT} g√ºnl√ºk hareket")
    print(f"   ‚Ä¢ Fiyat Aralƒ±ƒüƒ±: {MIN_PRICE}-{MAX_PRICE} TL")
    
    print(f"\nüü° ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LEN NOKTALAR:")
    print(f"   ‚Ä¢ Minimum Hacim: {MIN_VOLUME:,} (150k'dan artƒ±rƒ±ldƒ± - likidite korumasƒ±)")
    print(f"   ‚Ä¢ Hacim Artƒ±≈üƒ±: Son {VOLUME_LOOKBACK_DAYS} g√ºnl√ºk ortalama ile kar≈üƒ±la≈ütƒ±rma")
    print(f"   ‚Ä¢ Fiyat-EMA20: Maksimum %{MAX_PRICE_EMA20_DISTANCE*100:.0f} uzaklƒ±k (5%'den d√º≈ü√ºr√ºld√º)")
    print(f"   ‚Ä¢ Destek/Diren√ß: {SUPPORT_RESISTANCE_COUNT} seviye + g√º√ß analizi")
    
    print(f"\nüî¥ KRƒ∞Tƒ∞K DENGE NOKTALARI:")
    print(f"   ‚Ä¢ Destek Uzaklƒ±ƒüƒ±: Maksimum %{MAX_SUPPORT_DISTANCE*100:.0f}")
    print(f"   ‚Ä¢ Stop-loss: Maksimum %{MAX_STOP_LOSS_DISTANCE*100:.0f} (ger√ßek√ßi seviye)")
    print(f"   ‚Ä¢ Diren√ß Potansiyeli: Maksimum %{MAX_RESISTANCE_DISTANCE*100:.0f} (8%'den d√º≈ü√ºr√ºld√º)")
    
    print(f"\nüìä DESTEK G√ú√á SEVƒ∞YELERƒ∞:")
    print(f"   üî¥ √áok G√º√ßl√º (4-5 puan) | üü† G√º√ßl√º (3-4 puan)")
    print(f"   üü° Orta (2-3 puan) | üü¢ Zayƒ±f (1-2 puan) | ‚ö™ √áok Zayƒ±f (0-1 puan)")

def main():
    """Ana program"""
    print("üöÄ BIST Geli≈ümi≈ü Filtreli Hisse Tarayƒ±cƒ±sƒ± v3.0 - ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û")
    print("="*80)

    show_current_filters()

    choice = input(f"\nBIST100 taramasƒ± i√ßin 't', belirli hisseler i√ßin 'b' se√ßin (t/b): ").lower()

    if choice == 'b':
        selected_stocks = input("Hisse kodlarƒ±nƒ± virg√ºlle ayƒ±rarak girin (√∂rn: THYAO,AKBNK): ").split(',')
        selected_stocks = [stock.strip().upper() for stock in selected_stocks]
        filtered_results, all_results = scan_and_filter_stocks(selected_stocks)
        display_results(filtered_results, all_results, is_specific_search=True)
    elif choice == 't':
        filtered_results, all_results = scan_and_filter_stocks()
        display_results(filtered_results, all_results, is_specific_search=False)
    else:
        print("Ge√ßersiz se√ßim! Program sonlandƒ±rƒ±lƒ±yor.")
        return

if __name__ == "__main__":
    main()